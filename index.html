<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Web Vision Pro Demo</title>
    <!-- å¼•å…¥ MediaPipe åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; }
        body {
            margin: 0;
            padding: 0;
            background: #000;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            /* æ¨¡æ‹Ÿ Vision Pro çš„é€è§†èƒŒæ™¯æ„Ÿ */
            background: radial-gradient(circle at center, #2a2a2a 0%, #000 100%);
        }

        /* éšè—è§†é¢‘å…ƒç´ ï¼Œæˆ‘ä»¬åªéœ€è¦å®ƒçš„æ•°æ® */
        .input_video { display: none; }
        
        /* å¯åŠ¨æŒ‰é’® (iOSå¿…é¡»æ‰‹åŠ¨è§¦å‘) */
        #start-btn {
            position: absolute;
            z-index: 1000;
            padding: 15px 30px;
            background: white;
            color: black;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            cursor: pointer;
        }

        /* åº”ç”¨ç½‘æ ¼å®¹å™¨ */
        .app-grid {
            display: flex;
            gap: 40px;
            z-index: 10;
            transition: opacity 0.3s;
        }

        /* åº”ç”¨å›¾æ ‡æ ·å¼ (ç±»ç»ç’ƒæ‹Ÿæ€) */
        .app-icon {
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 500;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.2s, background 0.2s;
        }
        
        /* æ‚¬åœçŠ¶æ€ï¼ˆç”±JSæ§åˆ¶ï¼‰ */
        .app-icon.hovered {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.1);
        }

        .app-icon span { margin-top: 5px; font-size: 12px; pointer-events: none; }
        .icon-img { font-size: 30px; margin-bottom: 5px; pointer-events: none; }

        /* è™šæ‹Ÿå…‰æ ‡ (ç°åœˆ) */
        #cursor {
            position: fixed;
            top: 0; left: 0;
            width: 30px;
            height: 30px;
            background: rgba(200, 200, 200, 0.6);
            border-radius: 50%;
            pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€å…‰æ ‡ */
            transform: translate(-50%, -50%);
            z-index: 999;
            box-shadow: 0 0 10px rgba(255,255,255,0.3);
            transition: width 0.1s, height 0.1s, background 0.1s;
        }

        /* æåˆæ—¶çš„å…‰æ ‡çŠ¶æ€ */
        #cursor.clicking {
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.9);
        }

        /* æ‰“å¼€çš„åº”ç”¨çª—å£ */
        .window {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 80%;
            max-width: 400px;
            height: 300px;
            background: rgba(30, 30, 30, 0.85);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: none; /* é»˜è®¤éšè— */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
        }

        .window.open {
            display: flex;
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .close-btn {
            margin-top: 20px;
            padding: 10px 20px;
            background: #ff3b30;
            border-radius: 20px;
            border: none;
            color: white;
            font-weight: bold;
        }
        
        .close-btn.hovered { transform: scale(1.1); }

        /* è°ƒè¯•ä¿¡æ¯ */
        #status {
            position: absolute;
            bottom: 20px;
            color: rgba(255,255,255,0.4);
            font-size: 12px;
        }
    </style>
</head>
<body>

    <!-- è§†é¢‘æº -->
    <video class="input_video" playsinline></video>

    <!-- å¯åŠ¨æŒ‰é’® -->
    <button id="start-btn">è¿›å…¥ç©ºé—´ä½“éªŒ</button>

    <!-- è™šæ‹Ÿå…‰æ ‡ -->
    <div id="cursor"></div>

    <!-- åº”ç”¨åˆ—è¡¨ -->
    <div class="app-grid" id="main-menu">
        <div class="app-icon" id="app-settings">
            <div class="icon-img">âš™ï¸</div>
            <span>è®¾ç½®</span>
        </div>
        <div class="app-icon" id="app-hello">
            <div class="icon-img">ğŸ‘‹</div>
            <span>Hello</span>
        </div>
    </div>

    <!-- åº”ç”¨çª—å£: è®¾ç½® -->
    <div class="window" id="window-settings">
        <h2>è®¾ç½®</h2>
        <p>è¿™é‡Œæ˜¯è®¾ç½®ç•Œé¢ã€‚</p>
        <p>Vision Pro Web Demo v1.0</p>
        <button class="close-btn" id="close-settings">å…³é—­</button>
    </div>

    <!-- åº”ç”¨çª—å£: Hello -->
    <div class="window" id="window-hello">
        <h1>Hello World</h1>
        <p>æ¬¢è¿æ¥åˆ°ç©ºé—´è®¡ç®—ç½‘é¡µç‰ˆï¼</p>
        <button class="close-btn" id="close-hello">å…³é—­</button>
    </div>

    <div id="status">ç­‰å¾…ç›¸æœºå¯åŠ¨...</div>

    <script>
        const videoElement = document.getElementsByClassName('input_video')[0];
        const cursor = document.getElementById('cursor');
        const startBtn = document.getElementById('start-btn');
        const statusText = document.getElementById('status');
        const mainMenu = document.getElementById('main-menu');

        let isCameraRunning = false;
        let lastPinchTime = 0;
        let isPinching = false;

        // å¹³æ»‘ç§»åŠ¨å‚æ•°
        let cursorX = window.innerWidth / 2;
        let cursorY = window.innerHeight / 2;
        let targetX = window.innerWidth / 2;
        let targetY = window.innerHeight / 2;
        const lerpSpeed = 0.2; // å…‰æ ‡è·Ÿéšé€Ÿåº¦ (0.1 - 0.5)

        // åˆå§‹åŒ– MediaPipe Hands
        const hands = new Hands({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }});

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.7,
            minTrackingConfidence: 0.7
        });

        hands.onResults(onResults);

        // åˆå§‹åŒ–æ‘„åƒå¤´
        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await hands.send({image: videoElement});
            },
            width: 640,
            height: 480,
            facingMode: "user" // å¼ºåˆ¶å‰ç½®æ‘„åƒå¤´
        });

        // ç‚¹å‡»å¼€å§‹æŒ‰é’® (iOSå¿…é¡»)
        startBtn.addEventListener('click', () => {
            startBtn.style.display = 'none';
            statusText.innerText = "æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´...";
            camera.start()
                .then(() => {
                    statusText.innerText = "ä¼¸å‡ºæ‰‹æŒï¼Œé£ŸæŒ‡æ§åˆ¶å…‰æ ‡ï¼Œæåˆç‚¹å‡»";
                    isCameraRunning = true;
                })
                .catch(err => {
                    statusText.innerText = "æ‘„åƒå¤´å¯åŠ¨å¤±è´¥: " + err;
                    startBtn.style.display = 'block';
                });
        });

        // å¤„ç†æ‰‹éƒ¨è¿½è¸ªç»“æœ
        function onResults(results) {
            if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
                return;
            }

            const landmarks = results.multiHandLandmarks[0];
            
            // è·å–å…³é”®ç‚¹ï¼š8å·æ˜¯é£ŸæŒ‡æŒ‡å°–ï¼Œ4å·æ˜¯æ‹‡æŒ‡æŒ‡å°–
            const indexTip = landmarks[8];
            const thumbTip = landmarks[4];

            // 1. ç§»åŠ¨å…‰æ ‡é€»è¾‘
            // MediaPipe åæ ‡æ˜¯ 0-1ï¼Œéœ€è¦æ˜ å°„åˆ°å±å¹•åƒç´ 
            // æ³¨æ„ï¼šè‡ªæ‹æ¨¡å¼ä¸‹xè½´æ˜¯é•œåƒçš„ï¼Œæ‰€ä»¥ç”¨ (1 - x)
            const rawX = (1 - indexTip.x) * window.innerWidth;
            const rawY = indexTip.y * window.innerHeight;

            // å¹³æ»‘æ’å€¼ (Lerp) å‡å°‘æŠ–åŠ¨
            targetX = rawX;
            targetY = rawY;
            cursorX += (targetX - cursorX) * lerpSpeed;
            cursorY += (targetY - cursorY) * lerpSpeed;

            cursor.style.left = `${cursorX}px`;
            cursor.style.top = `${cursorY}px`;

            // 2. è®¡ç®—æåˆ (Pinch) è·ç¦»
            // ç®€å•çš„æ¬§å‡ é‡Œå¾—è·ç¦» (åªçœ‹ x å’Œ yï¼Œå¿½ç•¥æ·±åº¦ z ä»¥ç®€åŒ–)
            const dx = indexTip.x - thumbTip.x;
            const dy = indexTip.y - thumbTip.y;
            const distance = Math.sqrt(dx*dx + dy*dy);

            // é˜ˆå€¼ï¼šæ ¹æ®æ‰‹ç¦»æ‘„åƒå¤´çš„è·ç¦»ï¼Œè¿™ä¸ªå€¼å¯èƒ½éœ€è¦å¾®è°ƒï¼Œ0.05 æ¯”è¾ƒé€šç”¨
            const pinchThreshold = 0.05; 

            if (distance < pinchThreshold) {
                if (!isPinching) {
                    // åˆšå¼€å§‹æåˆ (Trigger Click)
                    isPinching = true;
                    cursor.classList.add('clicking');
                    handleInteraction(cursorX, cursorY);
                }
            } else {
                // æ¾å¼€
                isPinching = false;
                cursor.classList.remove('clicking');
            }

            // 3. å¤„ç†æ‚¬åœæ•ˆæœ (Hover)
            handleHover(cursorX, cursorY);
        }

        // å¤„ç†æ‚¬åœæ ·å¼
        function handleHover(x, y) {
            const elements = document.elementsFromPoint(x, y);
            // æ¸…é™¤æ‰€æœ‰æ‚¬åœçŠ¶æ€
            document.querySelectorAll('.hovered').forEach(el => el.classList.remove('hovered'));
            
            // æ·»åŠ æ–°çš„æ‚¬åœçŠ¶æ€
            for (let el of elements) {
                if (el.classList.contains('app-icon') || el.classList.contains('close-btn')) {
                    el.classList.add('hovered');
                    break; // åªé«˜äº®æœ€ä¸Šé¢çš„ä¸€ä¸ª
                }
            }
        }

        // å¤„ç†äº¤äº’ (ç‚¹å‡»)
        function handleInteraction(x, y) {
            // è·å–å…‰æ ‡ä½ç½®çš„æ‰€æœ‰å…ƒç´ 
            const elements = document.elementsFromPoint(x, y);
            
            for (let el of elements) {
                // å¦‚æœç‚¹å‡»äº†è®¾ç½®å›¾æ ‡
                if (el.id === 'app-settings') {
                    openWindow('window-settings');
                    return;
                }
                // å¦‚æœç‚¹å‡»äº†Helloå›¾æ ‡
                if (el.id === 'app-hello') {
                    openWindow('window-hello');
                    return;
                }
                // å¦‚æœç‚¹å‡»äº†å…³é—­æŒ‰é’®
                if (el.classList.contains('close-btn')) {
                    closeAllWindows();
                    return;
                }
            }
        }

        function openWindow(id) {
            mainMenu.style.opacity = '0';
            setTimeout(() => {
                mainMenu.style.display = 'none';
                const win = document.getElementById(id);
                win.classList.add('open');
            }, 300);
        }

        function closeAllWindows() {
            document.querySelectorAll('.window').forEach(w => {
                w.classList.remove('open');
            });
            
            mainMenu.style.display = 'flex';
            // å°å»¶è¿Ÿè®©æ·¡å…¥åŠ¨ç”»å¥½çœ‹
            setTimeout(() => {
                mainMenu.style.opacity = '1';
            }, 50);
        }

    </script>
</body>
</html>
