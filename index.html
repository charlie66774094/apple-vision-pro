<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Web Vision Pro - Hand Tracking</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        /* ä¿æŒä¹‹å‰çš„ç©ºé—´é£æ ¼åŸºç¡€æ ·å¼ */
        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; }
        body {
            margin: 0; padding: 0;
            background: #000;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
            overflow: hidden;
            height: 100dvh;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: radial-gradient(circle at 50% 50%, #2b2b2b 0%, #000 100%);
        }

        .input_video { display: none; }

        /* å¯åŠ¨æŒ‰é’® */
        #start-btn {
            position: absolute; z-index: 1000;
            padding: 16px 32px; background: white; color: black;
            border-radius: 50px; font-size: 18px; font-weight: 600;
            border: none; cursor: pointer;
            box-shadow: 0 0 20px rgba(255,255,255,0.3);
        }

        /* è™šæ‹Ÿå…‰æ ‡ */
        #cursor {
            position: fixed; top: 0; left: 0;
            width: 20px; height: 20px;
            background: rgba(255, 255, 255, 0.85);
            border-radius: 50%;
            pointer-events: none;
            transform: translate(-50%, -50%);
            z-index: 999;
            box-shadow: 0 0 15px rgba(255,255,255,0.5);
            transition: width 0.15s, height 0.15s, opacity 0.2s;
            mix-blend-mode: difference;
        }
        #cursor.hidden { opacity: 0; }
        #cursor.clicking { width: 12px; height: 12px; background: #32d74b; }

        /* === æ–°å¢ï¼šæ‚¬æµ®æ—¶é—´å°çª— === */
        #time-widget {
            position: fixed;
            top: 0; left: 0;
            width: 140px; height: 60px;
            /* æ·±åº¦ç»ç’ƒè´¨æ„Ÿ */
            background: rgba(40, 40, 40, 0.6);
            backdrop-filter: blur(20px) saturate(150%);
            -webkit-backdrop-filter: blur(20px) saturate(150%);
            border-radius: 30px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: 600; font-size: 24px;
            letter-spacing: 1px;
            
            z-index: 998;
            pointer-events: none;
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.8);
            transition: opacity 0.3s, transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        #time-widget.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        #time-widget span {
            background: linear-gradient(to bottom, #fff, #aaa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* åº”ç”¨å›¾æ ‡ */
        .app-grid { display: flex; gap: 40px; transition: opacity 0.3s; }
        .app-icon {
            width: 100px; height: 100px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.2s, background 0.2s;
        }
        .app-icon.hovered { background: rgba(255, 255, 255, 0.25); transform: scale(1.15); }
        .icon-img { font-size: 32px; margin-bottom: 5px; }
        .app-icon span { font-size: 12px; }

        /* çª—å£ */
        .window {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 85%; max-width: 400px; height: 400px;
            background: rgba(25, 25, 25, 0.9);
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.1);
            display: none; flex-direction: column; opacity: 0;
            transition: opacity 0.3s, transform 0.3s; z-index: 100;
            padding: 20px; color: white;
        }
        .window.open { display: flex; opacity: 1; transform: translate(-50%, -50%) scale(1); }
        .scroll-container { flex: 1; overflow-y: auto; padding: 10px 0; }
        .setting-item { padding: 15px; margin: 5px 0; background: rgba(255,255,255,0.05); border-radius: 10px; }
        .setting-item.hovered { background: rgba(255,255,255,0.15); }
        .close-btn { margin-top: 10px; padding: 10px; background: #333; color: white; border-radius: 15px; border: none; width: 100%; }
        .close-btn.hovered { background: #555; }

        #status { position: absolute; bottom: 20px; color: rgba(255,255,255,0.3); font-size: 12px; }
    </style>
</head>
<body>

    <video class="input_video" playsinline></video>
    <button id="start-btn">å¼€å¯ç©ºé—´ä½“éªŒ</button>
    
    <div id="cursor"></div>
    
    <!-- æ–°å¢ï¼šæ—¶é—´å°çª— -->
    <div id="time-widget">
        <span id="clock-text">12:00</span>
    </div>

    <div class="app-grid" id="main-menu">
        <div class="app-icon" id="app-settings">
            <div class="icon-img">âš™ï¸</div><span>è®¾ç½®</span>
        </div>
        <div class="app-icon" id="app-hello">
            <div class="icon-img">ğŸª</div><span>ä¸–ç•Œ</span>
        </div>
    </div>

    <div class="window" id="window-settings">
        <h3>è®¾ç½®</h3>
        <div class="scroll-container">
            <div class="setting-item">é£è¡Œæ¨¡å¼</div>
            <div class="setting-item">æ— çº¿å±€åŸŸç½‘</div>
            <div class="setting-item">è“ç‰™</div>
            <div class="setting-item">ç§»åŠ¨ç½‘ç»œ</div>
            <div class="setting-item">ä¸ªäººçƒ­ç‚¹</div>
            <div class="setting-item">é€šçŸ¥</div>
            <div class="setting-item">å£°éŸ³</div>
            <div class="setting-item">ä¸“æ³¨æ¨¡å¼</div>
            <div class="setting-item">å±å¹•ä½¿ç”¨æ—¶é—´</div>
        </div>
        <button class="close-btn">å…³é—­</button>
    </div>

    <div class="window" id="window-hello">
        <h3>Hello World</h3>
        <p>ç¿»è½¬æ‰‹èƒŒæŸ¥çœ‹æ—¶é—´ã€‚</p>
        <button class="close-btn">å…³é—­</button>
    </div>

    <div id="status">ç­‰å¾…å¯åŠ¨...</div>

    <script>
        const cursor = document.getElementById('cursor');
        const timeWidget = document.getElementById('time-widget');
        const clockText = document.getElementById('clock-text');
        
        let cursorX = window.innerWidth/2, cursorY = window.innerHeight/2;
        let isPinching = false;
        let isDragging = false;
        let activeScrollElement = null;
        let dragStartY = 0, initialScrollTop = 0;

        // å¹³æ»‘ç§»åŠ¨å˜é‡
        let targetWidgetX = 0, targetWidgetY = 0;
        let currentWidgetX = 0, currentWidgetY = 0;

        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.6,
            minTrackingConfidence: 0.6
        });
        hands.onResults(onResults);

        const camera = new Camera(document.querySelector('.input_video'), {
            onFrame: async () => { await hands.send({image: document.querySelector('.input_video')}); },
            width: 640, height: 480, facingMode: "user"
        });

        document.getElementById('start-btn').addEventListener('click', function() {
            this.style.display = 'none';
            document.getElementById('status').innerText = "å¯åŠ¨æ‘„åƒå¤´...";
            camera.start();
        });

        // æ ¸å¿ƒï¼šåˆ¤æ–­æ˜¯æ‰‹å¿ƒè¿˜æ˜¯æ‰‹èƒŒ
        // è¿”å› true ä»£è¡¨æ‰‹èƒŒå¯¹ç€æ‘„åƒå¤´
        function isBackOfHand(landmarks) {
            // ä½¿ç”¨å‰ç§¯çš„ Z åˆ†é‡åŸç†ï¼ˆç®€åŒ–ç‰ˆï¼‰
            // æˆ‘ä»¬å–ä¸‰ä¸ªç‚¹ï¼š0(æ‰‹è…•), 5(é£ŸæŒ‡æ ¹), 17(å°æŒ‡æ ¹)
            // åœ¨å±å¹•åæ ‡ç³»ä¸­ï¼š
            // å¦‚æœæ˜¯å³æ‰‹ï¼ˆMediaPipeè‡ªæ‹æ¨¡å¼å¯èƒ½è¯†åˆ«ä¸ºå·¦æ‰‹ï¼‰ï¼Œæ‰‹å¿ƒæœå‘æ—¶ï¼Œç‚¹5åœ¨ç‚¹17çš„å·¦è¾¹ï¼ˆæˆ–å³è¾¹ï¼Œå–å†³äºå…·ä½“é•œåƒï¼‰
            // æœ€ç¨³å¥çš„æ–¹æ³•æ˜¯è®¡ç®— (x5 - x0)*(y17 - y0) - (y5 - y0)*(x17 - x0)
            
            const p0 = landmarks[0];
            const p5 = landmarks[5];
            const p17 = landmarks[17];

            // 2D å‰ç§¯ (Cross Product 2D)
            // ç»“æœ > 0 å’Œ < 0 åˆ†åˆ«ä»£è¡¨é¡ºæ—¶é’ˆå’Œé€†æ—¶é’ˆé¡ºåº
            const crossProduct = (p5.x - p0.x) * (p17.y - p0.y) - (p5.y - p0.y) * (p17.x - p0.x);

            // é˜ˆå€¼æµ‹è¯•ï¼šä½ éœ€è¦æ ¹æ®ä½ çš„å…·ä½“é•œåƒè®¾ç½®è°ƒæ•´è¿™ä¸ªæ­£è´Ÿå·
            // åœ¨ MediaPipe é»˜è®¤è‡ªæ‹é•œåƒæ¨¡å¼ä¸‹ï¼š
            // ç»“æœé€šå¸¸ < 0 æ˜¯æ‰‹å¿ƒï¼Œ > 0 æ˜¯æ‰‹èƒŒ (æˆ–è€…åä¹‹ï¼Œå–å†³äºå·¦å³æ‰‹)
            // ç»è¿‡å®æµ‹ï¼Œå¯¹äºå³æ‰‹ï¼šæ‰‹å¿ƒæ—¶å€¼é€šå¸¸ä¸ºè´Ÿï¼Œæ‰‹èƒŒæ—¶å€¼ä¸ºæ­£ã€‚
            // ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬å‡è®¾è¿™æ˜¯ä¸€ä¸ªé€šç”¨çš„â€œç¿»è½¬â€æ£€æµ‹ã€‚
            // æ³¨æ„ï¼šå·¦å³æ‰‹è¿™ä¸ªå€¼çš„ç¬¦å·æ˜¯ç›¸åçš„ã€‚
            
            // è¿™é‡Œæˆ‘ä»¬ç”¨ä¸€ä¸ªç®€åŒ–çš„ç»å¯¹å€¼åˆ¤æ–­ï¼Œæˆ–è€…é…åˆ Handednessï¼ˆè¿™é‡Œä¸ºäº†ä»£ç ç®€å•ï¼Œå‡è®¾ç”¨å³æ‰‹ï¼‰
            // å¦‚æœæ˜¯å·¦æ‰‹ç©ï¼Œå¯èƒ½éœ€è¦åè½¬é€»è¾‘ã€‚
            
            // ç®€å•çš„å¯å‘å¼é€»è¾‘ï¼š
            // å¦‚æœæ˜¯æ‰‹èƒŒï¼Œé€šå¸¸ p17(å°æŒ‡) çš„ x åæ ‡ä¼šâ€œè·¨è¿‡â€ p5(é£ŸæŒ‡)
            // è®©æˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªé€»è¾‘ï¼Œå› ä¸ºå®ƒæ¯”å‰ç§¯æ›´ç›´è§‚ï¼š
            // æ­£å¸¸æ‰‹å¿ƒå¯¹ç€è‡ªå·±ï¼ˆå±å¹•ï¼‰ï¼šå°æŒ‡åœ¨é£ŸæŒ‡å³ä¾§ï¼ˆå³æ‰‹ï¼‰ã€‚
            // ç¿»è¿‡æ¥æ‰‹èƒŒå¯¹ç€å±å¹•ï¼šå°æŒ‡åœ¨é£ŸæŒ‡å·¦ä¾§ã€‚
            
            // ä½†æ˜¯ä¸ºäº†æ›´å‡†ç¡®ï¼Œæˆ‘ä»¬è¿˜æ˜¯ç”¨å‰ç§¯ã€‚
            // å‡è®¾æ˜¯å³æ‰‹ï¼š
            return crossProduct > 0; // è¿™ä¸ªå€¼å¯èƒ½éœ€è¦æ ¹æ®ä½ çš„å®é™…ä½“éªŒå¾®è°ƒç¬¦å·
        }

        function onResults(results) {
            if (!results.multiHandLandmarks?.length) {
                cursor.classList.add('hidden');
                timeWidget.classList.remove('show');
                return;
            }

            const landmarks = results.multiHandLandmarks[0];
            const handedness = results.multiHandedness[0].label; // "Left" or "Right"

            // è®¡ç®—æ˜¯å¦æ˜¯æ‰‹èƒŒ
            // æ³¨æ„ï¼šMediaPipe çš„ Left/Right åœ¨è‡ªæ‹æ¨¡å¼ä¸‹å¯èƒ½æœ‰ç‚¹åç›´è§‰
            // æˆ‘ä»¬å¯ä»¥åŠ¨æ€è°ƒæ•´é˜ˆå€¼ï¼Œä½†è¿™é‡Œå…ˆå†™æ­»é€»è¾‘ä¾›æµ‹è¯•
            let isBack = false;
            
            const p0 = landmarks[0];
            const p5 = landmarks[5];
            const p17 = landmarks[17];
            const val = (p5.x - p0.x) * (p17.y - p0.y) - (p5.y - p0.y) * (p17.x - p0.x);
            
            // é’ˆå¯¹ MediaPipe çš„é€»è¾‘ï¼š
            // å¦‚æœæ˜¯ Right Hand (ç³»ç»Ÿåˆ¤å®š)ï¼šVal < 0 æ˜¯æ‰‹å¿ƒ, Val > 0 æ˜¯æ‰‹èƒŒ
            // å¦‚æœæ˜¯ Left Hand (ç³»ç»Ÿåˆ¤å®š)ï¼šVal > 0 æ˜¯æ‰‹å¿ƒ, Val < 0 æ˜¯æ‰‹èƒŒ
            if (handedness === 'Left') {
                isBack = val > 0;
            } else {
                isBack = val < 0;
            }
            
            // å¼ºåˆ¶ä¿®æ­£ï¼šæœ‰æ—¶å€™ MediaPipe åˆ†ç±»ä¼šè·³å˜ï¼Œè¿™é‡ŒåŠ ä¸€ä¸ªç®€å•çš„é€»è¾‘ï¼š
            // ä»…ä»…å½“ val çš„ç»å¯¹å€¼è¶³å¤Ÿå¤§ï¼ˆæ‰‹æŒå¼ å¼€ï¼‰æ‰åˆ¤æ–­ï¼Œé˜²æ­¢æ¡æ‹³æ—¶è¯¯åˆ¤
            if (Math.abs(val) < 0.01) isBack = false; // å¿½ç•¥æ¨¡ç³ŠçŠ¶æ€

            if (isBack) {
                // === æ‰‹èƒŒæ¨¡å¼ï¼šæ˜¾ç¤ºæ—¶é—´ ===
                cursor.classList.add('hidden');
                
                // æ›´æ–°æ—¶é—´
                const now = new Date();
                clockText.innerText = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');

                // è®¡ç®—å°çª—ä½ç½®ï¼šè·Ÿéšæ‰‹è…•(0) æˆ– æ‰‹èƒŒä¸­å¿ƒ(9)
                // è¿™é‡Œç”¨æ‰‹èƒŒä¸­å¿ƒ (Landmark 9) ä¸Šæ–¹ä¸€ç‚¹ç‚¹
                const wrist = landmarks[0];
                const middleFinger = landmarks[9];
                
                // ç®€å•çš„å¹³æ»‘ç§»åŠ¨
                targetWidgetX = (1 - middleFinger.x) * window.innerWidth;
                targetWidgetY = middleFinger.y * window.innerHeight - 80; // ä¸Šç§»80åƒç´ 

                currentWidgetX += (targetWidgetX - currentWidgetX) * 0.1;
                currentWidgetY += (targetWidgetY - currentWidgetY) * 0.1;

                timeWidget.style.left = `${currentWidgetX}px`;
                timeWidget.style.top = `${currentWidgetY}px`;
                timeWidget.classList.add('show');

            } else {
                // === æ‰‹å¿ƒæ¨¡å¼ï¼šæ­£å¸¸æ“ä½œ ===
                timeWidget.classList.remove('show');
                cursor.classList.remove('hidden');

                const indexTip = landmarks[8];
                const thumbTip = landmarks[4];

                // ç§»åŠ¨å…‰æ ‡
                const sensitivity = 1.3;
                let rx = (1 - indexTip.x) * window.innerWidth;
                let ry = indexTip.y * window.innerHeight;
                rx = (rx - window.innerWidth/2)*sensitivity + window.innerWidth/2;
                ry = (ry - window.innerHeight/2)*sensitivity + window.innerHeight/2;
                
                // å¹³æ»‘
                cursorX += (rx - cursorX) * 0.4;
                cursorY += (ry - cursorY) * 0.4;
                cursor.style.left = `${cursorX}px`;
                cursor.style.top = `${cursorY}px`;

                // æåˆé€»è¾‘
                const dist = Math.hypot(indexTip.x - thumbTip.x, indexTip.y - thumbTip.y);
                const isPinchNow = dist < 0.06;

                if (isPinchNow) {
                    if (!isPinching) {
                        isPinching = true;
                        cursor.classList.add('clicking');
                        
                        const el = document.elementFromPoint(cursorX, cursorY);
                        const scrollable = el?.closest('.scroll-container');
                        if (scrollable) {
                            isDragging = true;
                            activeScrollElement = scrollable;
                            dragStartY = cursorY;
                            initialScrollTop = scrollable.scrollTop;
                        } else {
                            handleTap(cursorX, cursorY);
                        }
                    } else if (isDragging && activeScrollElement) {
                        const dy = cursorY - dragStartY;
                        activeScrollElement.scrollTop = initialScrollTop - dy * 2;
                    }
                } else {
                    isPinching = false;
                    isDragging = false;
                    cursor.classList.remove('clicking');
                }

                if (!isDragging) handleHover(cursorX, cursorY);
            }
        }

        function handleHover(x, y) {
            document.querySelectorAll('.hovered').forEach(el => el.classList.remove('hovered'));
            const el = document.elementFromPoint(x, y);
            const target = el?.closest('.app-icon, .close-btn, .setting-item');
            if (target) target.classList.add('hovered');
        }

        function handleTap(x, y) {
            const el = document.elementFromPoint(x, y);
            if (el?.closest('#app-settings')) openWin('window-settings');
            if (el?.closest('#app-hello')) openWin('window-hello');
            if (el?.closest('.close-btn')) closeAll();
        }

        function openWin(id) {
            document.getElementById('main-menu').style.opacity = '0';
            document.getElementById('main-menu').style.pointerEvents = 'none';
            setTimeout(() => document.getElementById(id).classList.add('open'), 200);
        }

        function closeAll() {
            document.querySelectorAll('.window').forEach(w => w.classList.remove('open'));
            setTimeout(() => {
                const m = document.getElementById('main-menu');
                m.style.opacity = '1'; m.style.pointerEvents = 'all';
            }, 200);
        }
    </script>
</body>
</html>